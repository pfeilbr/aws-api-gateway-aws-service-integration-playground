# aws-api-gateway-aws-service-integration-playground

> shows how an API Gateway endpoint can directly invoke an aws service like EventBridge, DynamoDB, etc.  No
lambda in the middle (reduces latency and costs).

HTTP REST APIs are the most common integration pattern.  API Gateway is AWS managed service for creating REST APIs.  It allows us to apply security, throttling, logging, etc. to our APIs.  In some cases an API is simply a passthrough to a backend AWS service.  The typical approach is to have API Gateway invoke a lambda, which then contains the code to call th target AWS service.  If you don't need to perform any additional logic to the request prior to calling the backend AWS service, you may be able to use an API Gateway AWS service integration, which can directly invoke the AWS service.  This simplifies the architecture, reduces request latency and reduces costs.

---


## Demo

**Prerequisites**

* [An AWS account](https://aws.amazon.com/)
* [AWS Command Line Interface](https://docs.aws.amazon.com/cli/latest/userguide/installing.html)
* [SAM CLI](https://aws.amazon.com/serverless/sam/)


```sh
# clone repo
git clone https://github.com/pfeilbr/aws-api-gateway-aws-service-integration-playground
cd aws-api-gateway-aws-service-integration-playground

# deploy
make deploy

# test
make test
```
example output
```json
{
    "Entries": [
        {
            "EventId": "58c635b4-21aa-09d8-0ad3-0874b7dc0a39"
        }
    ],
    "FailedEntryCount": 0
}
```

```sh
# teardown
make teardown
```

---

## Details

invoking the [EventBridge PutEvents](https://docs.aws.amazon.com/eventbridge/latest/APIReference/API_PutEvents.html) action with the request payload using the `APIGatewayEventBridgeAccessRole` role.

```yaml
Integration:
    Type: AWS
    Credentials: !GetAtt APIGatewayEventBridgeAccessRole.Arn
    IntegrationHttpMethod: POST
    Uri: !Sub "arn:aws:apigateway:${AWS::Region}:events:action/PutEvents"
```

setting the required headers to invoke the PutEvents action

```yaml
RequestTemplates:
    application/json: |
        $input.json("$")
        #set($context.requestOverride.header.X-Amz-Target ="AWSEvents.PutEvents")
        #set($context.requestOverride.header.Content-Type ="application/x-amz-json-1.1")
```

## Resources

* [Use API Gateway as a Proxy for Another AWS Service](https://aws.amazon.com/premiumsupport/knowledge-center/api-gateway-proxy-integrate-service/#:~:text=You%20can%20integrate%20many%20AWS,request%20parameters%20are%20correctly%20mapped.)
* [`AWS::ApiGateway::Method.Integration`](https://github.com/ThijsJung/phrasebook-API/blob/64d62722976ed9350a935b474a10a0a49ae3348b/cloudformation/phrasebook.yaml#L40) to dynamodb Query example
* [PutEvents - Amazon EventBridge](https://docs.aws.amazon.com/eventbridge/latest/APIReference/API_PutEvents.html)
* [CloudFormation Resources Generated By SAM](https://github.com/awslabs/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api)
* [API Gateway integration problem](https://forums.aws.amazon.com/thread.jspa?messageID=953197&#953197)